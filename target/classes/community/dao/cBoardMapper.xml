<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cBoardSQL">
	<!-- 자유게시판 글쓰기 -->
	<insert id="writeBoard" parameterType="java.util.Map">
		insert into cboard(bseq, nickname, subject, content, ref, show)
		values(seq_cboard.nextval, #{nickname}, #{subject}, #{content}, seq_cboard.currval, 'y')
	</insert>
	
	<!-- 자유게시판 글목록 -->
	<select id = "getCBoardList" parameterType="java.util.Map" resultType="cBoard">
		select * from (select rownum rn, tt.* 
	  	from (select * from cboard where show = 'y' order by ref desc, step asc)tt)
	  	where rn between #{startNum} and #{endNum}
	</select>
	
	<!-- 자유게시판 총 글 수 -->
	<select id = "getTotalA" resultType="int">
		select count(*) from cboard where show = 'y'
	</select>
	
	<!-- 공지사항 조회수 증가 -->
	<update id="hitUpdate" parameterType="int">
		update cboard set hit = hit+1 where bseq = #{bseq}
	</update>
	
	<!-- 자유게시판 글목록에서 삭제 -->
	<update id="deleteBoardAdmin" parameterType="String">
		begin
			update cboard set reply=reply-1 
			where bseq=(select pseq from cboard where bseq=#{temp});
			<!--원글을 찾아서 reply(답글수) 감소-->

			update cboard set subject='[원글이 삭제된 답글] ' ||subject where pseq=#{temp};
			<!--답글을 찾아서 제목에 추가-->

			update cboard set show = 'n' where bseq=#{temp};
			<!--삭제-->
		end;
	</update>
	
	<!-- 자유게시판 검색한 글목록 -->
	<select id="getCBoardSrch" parameterType="java.util.Map" resultType="cBoard">
		select * from (select rownum rn, tt.* 
	  	from (select * from cboard where show = 'y' and ${bSrchOption} like '%'||#{bKeyword}||'%' order by ref desc, step asc)tt)
	  	where rn between #{startNum} and #{endNum}
	</select>
	
	<!-- 자유게시판 검색한 글의 총 글 수 -->
	<select id ="getCBSrchTotalA" parameterType="java.util.Map" resultType="int">
		select count(*) from cboard where show = 'y' and ${bSrchOption} like '%'||#{bKeyword}||'%'
	</select>
	
	<!-- 자유게시판 글보기 -->
	<select id="viewBoard" parameterType="int" resultType="cBoard">
		select c.*, m.profile from cboard c inner join testmember m on c.nickname = m.nickname where c.bseq = #{bseq}
	</select>
	
	<!-- 자유게시판 글보기 이전글 -->
	<select id="viewPrevBoard" parameterType="int" resultType="cBoard">
		select * from (select rownum rn, tt.* 
	  	from (select * from cboard where show = 'y' and bseq &lt; #{bseq} order by ref desc, step asc)tt) 
	  	where rn = 1
	</select>
	
	<!-- 자유게시판 글보기 다음글 -->
	<select id="viewNextBoard" parameterType="int" resultType="cBoard">
		select * from (select rownum rn, tt.* 
	  	from (select * from cboard where show = 'y' and bseq &gt; #{bseq} order by ref, step desc)tt) 
	  	where rn = 1
	</select>
	
	<!-- 자유게시판 글보기 검색한 글 이전글 -->
	<select id="viewSrchPrevBoard" parameterType="java.util.Map" resultType="cBoard">
		select bseq from (select rownum rn, tt.* 
	  	from (select bseq from cboard where show = 'y' and ${bSrchOption} like '%'||#{bKeyword}||'%' and bseq &lt; #{bseq} order by ref desc, step asc)tt) 
	  	where rn = 1
	</select>
	
	<!-- 자유게시판 글보기 검색한 글 다음글 -->
	<select id="viewSrchNextBoard" parameterType="java.util.Map" resultType="cBoard">
		select bseq from (select rownum rn, tt.* 
	  	from (select bseq from cboard where show = 'y' and ${bSrchOption} like '%'||#{bKeyword}||'%' and bseq &gt; #{bseq} order by ref, step desc)tt) 
	  	where rn = 1
	</select>
	
	<!-- 자유게시판 글 수정 -->
	<update id="modifyBoard" parameterType="java.util.Map">
		update cboard set subject=#{subject}, content=#{content}, logtime=SYSDATE where bseq = #{bseq}
	</update>
	
	<!-- 자유게시판 글 삭제 -->
	<update id="deleteBoard" parameterType="int">
		begin
			update cboard set reply=reply-1 
			where bseq=(select pseq from cboard where bseq=#{bseq});
			<!--원글을 찾아서 reply(답글수) 감소-->

			update cboard set subject='[원글이 삭제된 답글] ' ||subject where pseq=#{bseq};
			<!--답글을 찾아서 제목에 추가-->

			update cboard set show = 'n' where bseq=#{bseq};
			<!--삭제-->
		end;
	</update>
	
	<!-- 자유게시판 답글쓰기 -->
	<insert id="replyBoard" parameterType="java.util.Map">
		begin 
			update cboard set step=step+1 where ref=#{ref} and step>#{step};
			insert into cboard values(seq_cboard.nextval
									,#{nickname}
									,'Re: '||#{subject}
									,#{content}
									,#{ref}
									,#{lev}+1
									,#{step}+1
									,#{pseq}
									,0
									,0
									,sysdate
									,'y');
			update cboard set reply=reply+1 where bseq=#{pseq};
		end;
	</insert>
	
	<!-- 자유게시판 댓글쓰기 -->
	<insert id="writeCmnt" parameterType="java.util.Map">
		insert into cb_cmnt(rseq, bseq, rnickname, rcontent, rref, rshow, secret)
		values(seq_cmnt.nextval, #{bseq}, #{rnickname}, #{rcontent}, seq_cmnt.currval, 'y', #{secret})
	</insert>

	<!-- 자유게시판 댓글목록 -->
	<select id = "getCmntList" parameterType="java.util.Map" resultType="cBCmnt">
		select * from (select rownum rn, tt.* 
	  	from (select cmnt.*, m.profile from cb_cmnt cmnt inner join testmember m on cmnt.rnickname = m.nickname where bseq = #{bseq} and rshow = 'y' order by rref desc, rstep asc)tt)
	  	where rn between #{startNum} and #{endNum}
	</select>
	
</mapper>